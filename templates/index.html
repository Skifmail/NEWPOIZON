<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poizon ‚Üí WordPress | –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4F46E5;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 40px auto;
            padding: 40px;
            max-width: 1400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6B7280;
            font-size: 1.1rem;
        }
        
        .header .logout-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header .logout-btn:hover {
            background: #DC2626;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
            text-decoration: none;
        }
        
        .header .logout-btn:active {
            transform: translateY(0);
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #E5E7EB;
            color: #9CA3AF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: var(--secondary-color);
            color: white;
        }
        
        .step.completed .step-number::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        .step-title {
            font-weight: 600;
            color: #6B7280;
        }
        
        .step.active .step-title {
            color: var(--primary-color);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .form-select, .form-control {
            border-radius: 10px;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .product-card {
            border: 2px solid #E5E7EB;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .product-card img {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .product-card a {
            text-decoration: none;
            color: inherit;
        }
        
        .product-card a:hover {
            text-decoration: none;
            color: inherit;
        }
        
        .product-card .product-link {
            position: relative;
            display: block;
        }
        
        .product-card .product-link::after {
            content: 'üîó';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 8px;
            border-radius: 15px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .product-card:hover .product-link::after {
            opacity: 1;
        }
        
        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            transform: translateY(-2px);
        }
        
        .product-card.selected {
            border-color: var(--primary-color);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .product-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .product-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 10px;
            margin-right: 20px;
        }
        
        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 14px 32px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover {
            background: #4338CA;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
        
        .btn-primary-custom:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" */
        #nextPageBtn {
            position: relative;
            overflow: hidden;
        }
        
        #nextPageBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(25, 135, 84, 0.6) !important;
        }
        
        #nextPageBtn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(25, 135, 84, 0.4) !important;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" */
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
            }
            50% {
                box-shadow: 0 6px 20px rgba(25, 135, 84, 0.7);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
            }
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner.active {
            display: flex;
        }
        
        .loading-spinner .spinner-border {
            width: 4rem !important;
            height: 4rem !important;
            border-width: 0.4rem;
        }
        
        .loading-spinner p {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            white-space: pre-line;
            text-align: center;
            max-width: 600px;
            padding: 0 20px;
        }
        
        .progress-bar-custom {
            height: 30px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .badge-custom {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .alert-custom {
            border-radius: 12px;
            border: none;
            padding: 16px 20px;
        }
        
        #resultsContainer {
            display: none;
            margin-top: 30px;
        }
        
        .result-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .result-item.success {
            background: #ECFDF5;
            border-color: var(--secondary-color);
        }
        
        .result-item.error {
            background: #FEF2F2;
            border-color: var(--danger-color);
        }
        
        .settings-panel {
            background: #F9FAFB;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .product-count {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-left: 10px;
        }
        
        /* Floating Scroll Buttons */
        .scroll-button {
            position: fixed;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 20px;
        }
        
        .scroll-button:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        
        .scroll-top {
            bottom: 100px;
        }
        
        .scroll-bottom {
            bottom: 40px;
        }
        
        /* Control Panel - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
        #controlPanel {
            position: sticky;
            top: 20px;
            z-index: 100;
            animation: slideDown 0.3s ease-out;
        }
        
        #updateControlPanel {
            position: sticky;
            top: 20px;
            z-index: 100;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Task Manager Styles */
        #taskManagerContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            z-index: 10000;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .task-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            overflow: hidden;
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .task-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-close {
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        
        .task-close:hover {
            color: #dc3545;
        }
        
        .task-body {
            padding: 15px;
        }
        
        .task-status {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .task-progress-wrapper {
            margin-bottom: 5px;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <a href="/logout" class="logout-btn" title="–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã">
                    <i class="fas fa-sign-out-alt"></i> –í—ã—Ö–æ–¥
                </a>
                <h1><i class="fas fa-shopping-bag"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ WordPress</h1>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Poizon API</p>
                <div class="mt-3">
                    <a href="/update" class="btn btn-lg btn-success">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
                    </a>
                </div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å —Ä—É—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-search"></i> –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ SPU ID –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" id="quickSearchInput" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ SPU ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 12179377) –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: NB480PEN-428)">
                        <button class="btn btn-warning" onclick="performQuickSearch()">
                            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä
                        </button>
                    </div>
                    <small class="text-muted">–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫ - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –±—Ä–µ–Ω–¥–∞</small>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
            <div id="quickSearchResults" style="display: none;" class="mb-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (<span id="quickSearchCount">0</span>)</h5>
                        <button class="btn btn-sm btn-outline-dark" onclick="closeQuickSearch()">
                            <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="quickSearchList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button">
                        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="mainTabContent">
            
            <!-- TAB 1: Upload Products -->
            <div class="tab-pane fade show active" id="uploadTab" role="tabpanel">
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">–í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">–í—ã–±–æ—Ä –±—Ä–µ–Ω–¥–∞</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">–í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-title">–ó–∞–≥—Ä—É–∑–∫–∞</div>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="card mb-4 border-primary" id="controlPanel" style="display: none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart"></i> –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ
                        </h5>
                    </div>
                    <div class="badge bg-light text-dark" style="font-size: 18px;">
                        –í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCountTop">0</strong> —Ç–æ–≤–∞—Ä–æ–≤
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                        <button class="btn btn-success btn-lg" id="uploadBtnTop">
                            <i class="fas fa-cloud-upload-alt"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ WordPress
                        </button>
                        <button class="btn btn-outline-primary" id="selectAllBtnTop">
                            <i class="fas fa-check-square"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        </button>
                        <button class="btn btn-outline-secondary" id="deselectAllBtnTop">
                            <i class="fas fa-square"></i> –°–Ω—è—Ç—å –≤—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        </button>
                        <span class="ms-auto text-muted">
                            <i class="fas fa-info-circle"></i> –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Settings Panel -->
            <div class="settings-panel">
                <h5 class="mb-3"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–Ω</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">–ö—É—Ä—Å —é–∞–Ω—è –∫ —Ä—É–±–ª—é</label>
                        <input type="number" class="form-control" id="currencyRate" value="13.5" step="0.1" min="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ (–≤ —Ä—É–±–ª—è—Ö)</label>
                        <input type="number" class="form-control" id="markupRubles" value="5000" step="100" min="0">
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        –ü—Ä–∏–º–µ—Ä: 100¬• √ó <span id="rateDisplay">13.5</span> + <span id="markupDisplay">5000</span>‚ÇΩ = 
                        <strong><span id="priceExample">1850</span>‚ÇΩ</strong>
                    </small>
                </div>
            </div>
            
            <!-- Step 1: Category Selection (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê) -->
            <div class="form-section" id="categorySection">
                <label class="form-label"><i class="fas fa-list"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
                <select class="form-select" id="categorySelect">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            
            <!-- Step 2: Brand Selection -->
            <div class="form-section" id="brandSection" style="display: none;">
                <label class="form-label"><i class="fas fa-tag"></i> –í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</label>
                
                <!-- –ü–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–∞ -->
                <div class="mb-3" id="brandSearchContainer" style="display: none;">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="brandSearchInput" 
                               placeholder="–ü–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." 
                               onkeyup="filterBrands()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearBrandSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted">–ù–∞–π–¥–µ–Ω–æ –±—Ä–µ–Ω–¥–æ–≤: <span id="brandCount">0</span></small>
                </div>
                
                <select class="form-select" id="brandSelect" size="8">
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>
            
            <!-- Step 3: Products Selection -->
            <div class="form-section" id="productsSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="form-label mb-0">
                        <i class="fas fa-box"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                    </label>
                    <div class="badge bg-primary" style="font-size: 16px; padding: 10px 15px;">
                        <i class="fas fa-shopping-cart"></i> –í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCount">0</strong>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-primary btn-sm" id="selectAllBtn">
                        <i class="fas fa-check-square"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="deselectAllBtn">
                        <i class="fas fa-square"></i> –°–Ω—è—Ç—å –≤—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    </button>
                    <span class="ms-3">
                        <strong>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</strong> <span id="currentPage">1</span>
                    </span>
                </div>
                
                <div id="productsContainer" class="row">
                    <!-- Products will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <div class="mt-4" id="paginationControls" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button class="btn btn-secondary" id="prevPageBtn" disabled>
                            <i class="fas fa-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </button>
                        <div id="pageNumbers" class="d-flex gap-2">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button class="btn btn-success btn-lg fw-bold" id="nextPageBtn" style="box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4); transition: all 0.3s ease;">
                            –°–ª–µ–¥—É—é—â–∞—è <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="text-center">
                        <span class="badge bg-primary">–¢–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: <span id="pageProductCount">0</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="mt-3" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            
            <!-- Upload Button -->
            <div class="text-center" id="uploadSection" style="display: none;">
                <button class="btn btn-primary-custom" id="uploadBtn" disabled>
                    <i class="fas fa-cloud-upload-alt"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ WordPress
                </button>
            </div>
            
            <!-- Progress Section -->
            <div id="progressSection" style="display: none; margin-top: 30px;">
                <h5>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</h5>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" 
                         role="progressbar" 
                         style="width: 0%;">0%</div>
                </div>
                <p class="mt-2 text-center" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
                
                <!-- Detailed Progress Log -->
                <div class="mt-3" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;">
                    <div id="progressLog" style="font-family: 'Courier New', monospace; font-size: 13px;"></div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="resultsContainer">
                <h5><i class="fas fa-check-circle text-success"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏</h5>
                <div id="resultsContent"></div>
            </div>
            
            </div>
            <!-- End TAB 1 -->
            
            </div>
            <!-- End tab-content -->
            
        </div>
    </div>
    
    <!-- Floating Scroll Buttons -->
    <div id="scrollToTop" class="scroll-button scroll-top" onclick="scrollToTop()" style="display: none;">
        <i class="fas fa-chevron-up"></i>
    </div>
    <div id="scrollToBottom" class="scroll-button scroll-bottom" onclick="scrollToBottom()">
        <i class="fas fa-chevron-down"></i>
    </div>
    
    <!-- Task Manager Container -->
    <div id="taskManagerContainer"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Script -->
    <script>
        // ========================================================================
        // TASK MANAGER CLASS
        // ========================================================================
        class TaskManager {
            constructor() {
                this.tasks = new Map();
                this.container = document.getElementById('taskManagerContainer');
            }

            addTask(taskId, totalProducts, type = 'upload', isGroup = false) {
                const task = {
                    id: taskId,
                    total: totalProducts,
                    current: 0,
                    status: 'starting',
                    type: type,
                    isGroup: isGroup,
                    startTime: new Date(),
                    element: this.createTaskElement(taskId, type, totalProducts)
                };
                
                this.tasks.set(taskId, task);
                this.container.style.display = 'block';
                this.container.appendChild(task.element);
                
                // Start polling
                this.startPolling(taskId);
                
                return task;
            }

            createTaskElement(taskId, type, total) {
                const div = document.createElement('div');
                div.className = 'task-card';
                div.id = `task-${taskId}`;
                
                const title = type === 'upload' ? '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤' : '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤';
                const icon = type === 'upload' ? 'fa-cloud-upload-alt' : 'fa-sync-alt';
                
                div.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">
                            <i class="fas ${icon}"></i> ${title}
                        </div>
                        <div class="task-close" onclick="taskManager.removeTask('${taskId}')">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="task-body">
                        <div class="task-status" id="status-${taskId}">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
                        <div class="progress task-progress-wrapper" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progress-${taskId}" 
                                 role="progressbar" 
                                 style="width: 0%"></div>
                        </div>
                        <div class="task-meta">
                            <span id="count-${taskId}">0 / ${total}</span>
                            <span id="percent-${taskId}">0%</span>
                        </div>
                    </div>
                `;
                
                return div;
            }

            updateTask(taskId, current, total, status, state = 'PROGRESS') {
                const task = this.tasks.get(taskId);
                if (!task) return;
                
                task.current = current;
                task.status = status;
                
                // Update UI
                const percent = Math.round((current / total) * 100);
                const progressBar = document.getElementById(`progress-${taskId}`);
                const statusEl = document.getElementById(`status-${taskId}`);
                const countEl = document.getElementById(`count-${taskId}`);
                const percentEl = document.getElementById(`percent-${taskId}`);
                
                if (progressBar) progressBar.style.width = `${percent}%`;
                if (statusEl) statusEl.textContent = status;
                if (countEl) countEl.textContent = `${current} / ${total}`;
                if (percentEl) percentEl.textContent = `${percent}%`;
                
                // Change color based on state
                if (state === 'SUCCESS') {
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    document.getElementById(`task-${taskId}`).style.borderLeftColor = 'var(--secondary-color)';
                } else if (state === 'FAILURE') {
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    document.getElementById(`task-${taskId}`).style.borderLeftColor = 'var(--danger-color)';
                }
            }

            removeTask(taskId) {
                const task = this.tasks.get(taskId);
                if (task) {
                    task.element.remove();
                    this.tasks.delete(taskId);
                    
                    if (this.tasks.size === 0) {
                        this.container.style.display = 'none';
                    }
                }
            }

            startPolling(taskId) {
                let pollCount = 0;
                const maxPolls = 3600; // 1 —á–∞—Å
                const task = this.tasks.get(taskId);
                const endpoint = task.isGroup ? `/api/group-status/${taskId}` : `/api/task-status/${taskId}`;
                
                const pollInterval = setInterval(async () => {
                    pollCount++;
                    
                    try {
                        const response = await fetch(endpoint);
                        const data = await response.json();
                        
                        if (!data.success) {
                            this.updateTask(taskId, 0, 0, `–û—à–∏–±–∫–∞: ${data.error}`, 'FAILURE');
                            clearInterval(pollInterval);
                            return;
                        }
                        
                        if (task.isGroup) {
                            // Logic for Group Status
                            const percent = data.progress;
                            const completed = data.completed;
                            const total = data.total || task.total;
                            
                            this.updateTask(taskId, completed, total, `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${completed}/${total}`, 'PROGRESS');
                            
                            if (data.ready) {
                                clearInterval(pollInterval);
                                const results = data.results;
                                let successCount = 0;
                                if (results && Array.isArray(results)) {
                                    successCount = results.filter(r => r && (r.status === 'completed' || r.status === 'created' || r.status === 'updated')).length;
                                }
                                
                                this.updateTask(taskId, total, total, `–ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ: ${successCount}`, 'SUCCESS');
                                showNotification(`–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${successCount}`, 'success');
                                
                                if (task.type === 'upload') {
                                    selectedProducts.clear();
                                    renderProducts(allProducts, true);
                                    updateSelectedCount();
                                }
                            }
                        } else {
                            // Logic for Single Task Status (Old logic)
                            if (data.state === 'PROGRESS' && data.progress) {
                                this.updateTask(taskId, data.progress.current, data.progress.total, data.progress.status);
                            } else if (data.ready) {
                                clearInterval(pollInterval);
                                
                                if (data.status === 'completed') {
                                    const result = data.result;
                                    let completed = 0;
                                    
                                    if (result && result.results && Array.isArray(result.results)) {
                                        completed = (result.created || 0) + (result.updated || 0);
                                    } else if (Array.isArray(result)) {
                                        completed = result.filter(r => r.status === 'completed' || r.status === 'created' || r.status === 'updated').length;
                                    } else {
                                        completed = 1;
                                    }
                                    
                                    this.updateTask(taskId, this.tasks.get(taskId).total, this.tasks.get(taskId).total, `–ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ: ${completed}`, 'SUCCESS');
                                    showNotification(`–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${completed}`, 'success');
                                    
                                    if (this.tasks.get(taskId).type === 'upload') {
                                        selectedProducts.clear();
                                        renderProducts(allProducts, true);
                                        updateSelectedCount();
                                    }
                                } else {
                                    this.updateTask(taskId, 0, 0, `–û—à–∏–±–∫–∞: ${data.error}`, 'FAILURE');
                                    showNotification(`–û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏: ${data.error}`, 'danger');
                                }
                            }
                        }
                        
                        if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                            this.updateTask(taskId, 0, 0, '–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è', 'FAILURE');
                        }
                        
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 2000); // –û–ø—Ä–æ—Å —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
            }
        }
        
        const taskManager = new TaskManager();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedProducts = new Set();
        let allProducts = [];
        let currentPage = 0;
        let currentBrand = '';
        let currentCategory = '';
        let hasMoreProducts = false;
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è)
        let currentDisplayPage = 1;
        const itemsPerPage = 20;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadSimplifiedCategories();  // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: —Å–Ω–∞—á–∞–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!
            initEventListeners();
            updatePriceExample();
            
            // Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            document.getElementById('quickSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performQuickSearch();
                }
            });
        });
        
        // Event Listeners
        function initEventListeners() {
            document.getElementById('brandSelect').addEventListener('change', onBrandChange);
            document.getElementById('categorySelect').addEventListener('change', onCategoryChange);
            document.getElementById('uploadBtn').addEventListener('click', uploadProducts);
            document.getElementById('uploadBtnTop').addEventListener('click', uploadProducts);
            document.getElementById('selectAllBtn').addEventListener('click', selectAllProducts);
            document.getElementById('selectAllBtnTop').addEventListener('click', selectAllProducts);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllProducts);
            document.getElementById('deselectAllBtnTop').addEventListener('click', deselectAllProducts);
            document.getElementById('currencyRate').addEventListener('input', updatePriceExample);
            document.getElementById('markupRubles').addEventListener('input', updatePriceExample);
            document.getElementById('prevPageBtn').addEventListener('click', prevPage);
            document.getElementById('nextPageBtn').addEventListener('click', nextPage);
        }
        
        // Update price example
        function updatePriceExample() {
            const rate = parseFloat(document.getElementById('currencyRate').value) || 13.5;
            const markup = parseFloat(document.getElementById('markupRubles').value) || 5000;
            const example = Math.round(100 * rate + markup);
            
            document.getElementById('rateDisplay').textContent = rate;
            document.getElementById('markupDisplay').textContent = markup;
            document.getElementById('priceExample').textContent = example;
        }
        
        // ========================================================================
        // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò
        // ========================================================================
        
        let selectedCategoryId = null;
        
        // Step 1: Load simplified categories
        async function loadSimplifiedCategories() {
            showLoading(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
            
            try {
                const response = await fetch('/api/categories/simplified');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('categorySelect');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>';
                    
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        option.dataset.categoryId = cat.id;
                        select.appendChild(option);
                    });
                    
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.categories.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`, 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // Step 1: On category change (–∑–∞–≥—Ä—É–∂–∞–µ–º –±—Ä–µ–Ω–¥—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
        async function onCategoryChange(event) {
            const categoryId = event.target.value;
            
            if (!categoryId) {
                document.getElementById('brandSection').style.display = 'none';
                document.getElementById('productsSection').style.display = 'none';
                updateStep(1);
                return;
            }
            
            selectedCategoryId = parseInt(categoryId);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–æ–≤
            document.getElementById('brandSearchContainer').style.display = 'none';
            document.getElementById('brandSearchInput').value = '';
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categorySelect = document.getElementById('categorySelect');
            const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoading(true, `–ü–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"...\n\n–ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 —Å–µ–∫—É–Ω–¥`);
            
            document.getElementById('brandSection').style.display = 'block';
            document.getElementById('brandSelect').disabled = true;
            
            updateStep(2);
            
            try {
                const response = await fetch(`/api/brands/by-category?category_id=${categoryId}`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('brandSelect');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥ --</option>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –±—Ä–µ–Ω–¥—ã —Å –ª–æ–≥–æ—Ç–∏–ø–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–≤–∞—Ä–æ–≤
                    data.brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.name;
                        const count = brand.products_count > 0 ? ` (${brand.products_count})` : '';
                        option.textContent = `${brand.name}${count}`;
                        option.dataset.brandId = brand.id;
                        select.appendChild(option);
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    document.getElementById('brandSearchContainer').style.display = 'block';
                    updateBrandCount();
                    
                    showNotification(`–ù–∞–π–¥–µ–Ω–æ ${data.brands.length} –±—Ä–µ–Ω–¥–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏`, 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–µ–Ω–¥–æ–≤: ' + error.message, 'danger');
            } finally {
                showLoading(false);
                document.getElementById('brandSelect').disabled = false;
            }
        }
        
        // Step 2: On brand change (–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã)
        async function onBrandChange(event) {
            const brand = event.target.value;
            
            if (!brand) {
                document.getElementById('productsSection').style.display = 'none';
                updateStep(2);
                return;
            }
            
            currentBrand = brand;
            currentPage = 0;
            
            updateStep(3);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            await loadProducts(selectedCategoryId, brand, 0);
        }
        
        // –°–¢–ê–†–ê–Ø –§–£–ù–ö–¶–ò–Ø loadBrands() - —Ç–µ–ø–µ—Ä—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadBrands() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/brands');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('brandSelect');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥ --</option>';
                    
                    data.brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.name;
                        option.textContent = brand.name;
                        option.dataset.brandId = brand.id;
                        select.appendChild(option);
                    });
                    
                    showNotification('–ë—Ä–µ–Ω–¥—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–µ–Ω–¥–æ–≤: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // Step 3: Load products (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!)
        async function loadProducts(categoryId, brand, page) {
            showLoading(true, `–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –±—Ä–µ–Ω–¥–∞ ${brand}...\n\n–ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥`);
            updateStep(3);
            
            try {
                // –ù–û–í–´–ô API —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π category_id!
                const response = await fetch(`/api/products?brand=${encodeURIComponent(brand)}&category_id=${categoryId}&page=${page}`);
                const data = await response.json();
                
                if (data.success) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (page=0), –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–≤–∞—Ä—ã
                    // –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
                    if (page === 0) {
                        allProducts = data.products;
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã, –∏–∑–±–µ–≥–∞—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                        const existingIds = new Set(allProducts.map(p => p.spuId));
                        const newProducts = data.products.filter(p => !existingIds.has(p.spuId));
                        allProducts = [...allProducts, ...newProducts];
                    }
                    
                    currentPage = page;
                    hasMoreProducts = data.has_more;
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ï—Å–ª–∏ –¥–æ–≥—Ä—É–∑–∫–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                    renderProducts(allProducts, page > 0); // renderProducts –≤—ã–∑–æ–≤–µ—Ç updatePaginationUI –≤–Ω—É—Ç—Ä–∏
                    
                    document.getElementById('productsSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'block';
                    
                    if (page === 0) {
                        showNotification(`–ù–∞–π–¥–µ–Ω–æ ${data.total} —Ç–æ–≤–∞—Ä–æ–≤`, 'success');
                    } else {
                        showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –µ—â–µ ${data.total} —Ç–æ–≤–∞—Ä–æ–≤ (–≤—Å–µ–≥–æ: ${allProducts.length})`, 'success');
                    }
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // –°–¢–ê–†–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è loadProductsPage (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async function loadProductsPage(page) {
            if (selectedCategoryId && currentBrand) {
                await loadProducts(selectedCategoryId, currentBrand, page);
            }
        }
        
        // Render products with pagination
        function renderProducts(products, keepCurrentPage = false) {
            allProducts = products; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
            if (!keepCurrentPage) {
                currentDisplayPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            }
            renderCurrentPage();
        }
        
        // Render current page of products
        function renderCurrentPage() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (allProducts.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const startIndex = (currentDisplayPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, allProducts.length);
            const pageProducts = allProducts.slice(startIndex, endIndex);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            pageProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'col-12';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä Dewu
                const dewuUrl = `https://www.dewu.com/product-detail.html?sourceName=pc&spuId=${product.spuId}&propertyValueId=0&skuId=${product.sku || product.spuId}`;
                
                card.innerHTML = `
                    <a href="${dewuUrl}" target="_blank" class="product-link">
                        <div class="product-card" data-product-id="${product.spuId}">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="product-checkbox" data-product-id="${product.spuId}" 
                                       ${selectedProducts.has(product.spuId) ? 'checked' : ''}>
                                <img src="${product.images[0] || 'https://via.placeholder.com/120'}" 
                                     class="product-image" 
                                     alt="${product.title}">
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">${product.title}</h6>
                                    <p class="mb-2 text-muted small">${product.description}</p>
                                    <div>
                                        <span class="badge bg-primary">${product.brand}</span>
                                        <span class="badge bg-secondary">${product.category}</span>
                                        <span class="badge bg-info">${product.variationsCount} —Ä–∞–∑–º–µ—Ä–æ–≤</span>
                                        <span class="badge bg-dark">–ê—Ä—Ç–∏–∫—É–ª: ${product.articleNumber}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
                
                // Add click handler
                const checkbox = card.querySelector('.product-checkbox');
                const productCard = card.querySelector('.product-card');
                
                if (selectedProducts.has(product.spuId)) {
                    productCard.classList.add('selected');
                }
                
                checkbox.addEventListener('change', function(event) {
                    event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
                    if (this.checked) {
                        selectedProducts.add(product.spuId);
                        productCard.classList.add('selected');
                    } else {
                        selectedProducts.delete(product.spuId);
                        productCard.classList.remove('selected');
                    }
                    updateSelectedCount();
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞
                checkbox.addEventListener('click', function(event) {
                    event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
                });
                
                // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ - —Ç–µ–ø–µ—Ä—å —Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
                // productCard.addEventListener('click', function(e) {
                //     if (e.target.type !== 'checkbox') {
                //         e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
                //         checkbox.checked = !checkbox.checked;
                //         checkbox.dispatchEvent(new Event('change'));
                //     }
                // });
                
                container.appendChild(card);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updatePaginationUI();
        }
        
        // Update pagination UI
        function updatePaginationUI() {
            const totalPages = Math.ceil(allProducts.length / itemsPerPage);
            const paginationControls = document.getElementById('paginationControls');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (allProducts.length > itemsPerPage) {
                paginationControls.style.display = 'block';
            } else {
                paginationControls.style.display = 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('currentPage').textContent = currentDisplayPage;
            document.getElementById('pageProductCount').textContent = 
                `${(currentDisplayPage - 1) * itemsPerPage + 1}-${Math.min(currentDisplayPage * itemsPerPage, allProducts.length)} –∏–∑ ${allProducts.length}${hasMoreProducts ? '+' : ''}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('prevPageBtn').disabled = currentDisplayPage === 1;
            // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –¥–æ—Å—Ç—É–ø–Ω–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ò–õ–ò –º–æ–∂–Ω–æ –¥–æ–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
            document.getElementById('nextPageBtn').disabled = currentDisplayPage === totalPages && !hasMoreProducts;
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –º–æ–∂–Ω–æ –¥–æ–≥—Ä—É–∑–∏—Ç—å
            const nextBtn = document.getElementById('nextPageBtn');
            if (currentDisplayPage === totalPages && hasMoreProducts) {
                nextBtn.innerHTML = '<i class="bi bi-cloud-download-fill"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ —Ç–æ–≤–∞—Ä—ã';
                nextBtn.classList.add('pulse-animation');
            } else {
                nextBtn.innerHTML = '–°–ª–µ–¥—É—é—â–∞—è <i class="fas fa-chevron-right"></i>';
                nextBtn.classList.remove('pulse-animation');
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
            let startPage = Math.max(1, currentDisplayPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentDisplayPage ? 'btn-primary' : 'btn-outline-primary'}`;
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
        }
        
        // Navigate to specific page
        function goToPage(page) {
            currentDisplayPage = page;
            renderCurrentPage();
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            document.getElementById('productsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Navigate to next page
        async function nextPage() {
            const totalPages = Math.ceil(allProducts.length / itemsPerPage);
            
            // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ò –µ—Å—Ç—å –µ—â–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            if (currentDisplayPage >= totalPages && hasMoreProducts) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –±–∞—Ç—á —Ç–æ–≤–∞—Ä–æ–≤
                try {
                    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤...');
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (categoryId, brand, page)
                    await loadProducts(selectedCategoryId, currentBrand, currentPage + 1);
                    hideLoading();
                    
                    // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    if (allProducts.length > currentDisplayPage * itemsPerPage) {
                        goToPage(currentDisplayPage + 1);
                    }
                } catch (error) {
                    hideLoading();
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + error.message);
                }
            } else if (currentDisplayPage < totalPages) {
                // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                goToPage(currentDisplayPage + 1);
            } else {
                // –ë–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç
                showError('–≠—Ç–æ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã');
            }
        }
        
        // Navigate to previous page
        function prevPage() {
            if (currentDisplayPage > 1) {
                goToPage(currentDisplayPage - 1);
            }
        }
        
        // Update selected count
        function updateSelectedCount() {
            const count = selectedProducts.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedCountTop').textContent = count;
            document.getElementById('uploadBtn').disabled = count === 0;
            document.getElementById('uploadBtnTop').disabled = count === 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            const controlPanel = document.getElementById('controlPanel');
            if (count > 0) {
                controlPanel.style.display = 'block';
                updateStep(4);
            } else {
                controlPanel.style.display = 'none';
            }
        }
        
        // Select all products
        function selectAllProducts() {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
        
        // Deselect all products
        function deselectAllProducts() {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
        
        // Step 4: Upload products with real-time progress via SSE
        async function uploadProducts() {
            if (selectedProducts.size === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä', 'warning');
                return;
            }
            
            const settings = {
                currency_rate: parseFloat(document.getElementById('currencyRate').value) || 13.5,
                markup_rubles: parseFloat(document.getElementById('markupRubles').value) || 5000
            };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoading(true, `–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ${selectedProducts.size} —Ç–æ–≤–∞—Ä–æ–≤...`);
            
            try {
                // Step 1: Start upload and get session_id
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_ids: Array.from(selectedProducts),
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                    showLoading(false);
                    return;
                }
                
                const sessionId = data.session_id;
                const totalProducts = data.total;
                const mode = data.mode; // 'celery' –∏–ª–∏ 'threading'
                const taskId = data.task_id; // –¢–æ–ª—å–∫–æ –¥–ª—è Celery
                
                // Step 2: –†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è Celery –∏ Threading
                if (mode === 'celery' && taskId) {
                    // CELERY MODE: –ò—Å–ø–æ–ª—å–∑—É–µ–º TaskManager
                    showLoading(false); // –£–±–∏—Ä–∞–µ–º –±–ª–æ–∫–∏—Ä—É—é—â–∏–π —ç–∫—Ä–∞–Ω
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –º–µ–Ω–µ–¥–∂–µ—Ä (isGroup = true)
                    taskManager.addTask(taskId, totalProducts, 'upload', true);
                    
                    showNotification(`–ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.`, 'info');
                    
                    // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä, —Ç–∞–∫ –∫–∞–∫ –∑–∞–¥–∞—á–∞ —É—à–ª–∞ –≤ —Ñ–æ–Ω
                    selectedProducts.clear();
                    renderProducts(allProducts, true);
                    updateSelectedCount();
                    
                } else {
                    // THREADING MODE: –∏—Å–ø–æ–ª—å–∑—É–µ–º SSE –¥–ª—è real-time –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Å—Ç–∞—Ä—ã–π —Ä–µ–∂–∏–º)
                    // Show progress section
                    document.getElementById('progressSection').style.display = 'block';
                    document.getElementById('progressLog').innerHTML = '';
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressBar').textContent = '0%';
                    document.getElementById('progressText').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
                    document.getElementById('uploadBtn').disabled = true;
                    document.getElementById('uploadBtnTop').disabled = true;
                    
                    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –±–ª–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    setTimeout(() => {
                        const progressSection = document.getElementById('progressSection');
                        if (progressSection) {
                            progressSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 300);

                    const eventSource = new EventSource(`/api/progress/${sessionId}`);
                    let currentProduct = 0;
                    let results = [];
                    
                    eventSource.onmessage = function(event) {
                        const message = JSON.parse(event.data);
                    
                        switch(message.type) {
                            case 'start':
                                addProgressLog(`üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É ${message.total} —Ç–æ–≤–∞—Ä–æ–≤...`, 'info');
                                showLoading(false);
                                break;
                                
                            case 'product_start':
                                currentProduct = message.current;
                                addProgressLog(`üì¶ [${message.current}/${message.total}] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞ ${message.spu_id}...`, 'info');
                                updateProgress(currentProduct, totalProducts, message.message);
                                break;
                                
                            case 'status_update':
                                addProgressLog(`   ‚ûú ${message.message}`, 'detail');
                                break;
                                
                            case 'product_done':
                                const icon = message.status === 'completed' ? '‚úÖ' : '‚ùå';
                                const color = message.status === 'completed' ? 'success' : 'danger';
                                addProgressLog(`${icon} [${message.current}/${message.total}] ${message.message}`, color);
                                updateProgress(message.current, totalProducts, message.message);
                                break;
                                
                            case 'complete':
                                results = message.results;
                                addProgressLog(`‚ú® –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${message.completed}, –û—à–∏–±–æ–∫: ${message.errors}`, 'success');
                                showResults({results: results, total: message.total, completed: message.completed, errors: message.errors});
                                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${message.completed} –∏–∑ ${message.total}`, 'success');
                                
                                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                                selectedProducts.clear();
                                renderProducts(allProducts, true);
                                updateSelectedCount();
                                break;
                                
                            case 'error':
                                addProgressLog(`‚ùå –û—à–∏–±–∫–∞: ${message.message}`, 'danger');
                                showNotification('–û—à–∏–±–∫–∞: ' + message.message, 'danger');
                                break;
                                
                            case 'done':
                                eventSource.close();
                                document.getElementById('uploadBtn').disabled = false;
                                document.getElementById('uploadBtnTop').disabled = false;
                                break;
                        }
                    };
                
                    eventSource.onerror = function(error) {
                        console.error('SSE Error:', error);
                        eventSource.close();
                        addProgressLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
                        document.getElementById('uploadBtn').disabled = false;
                        document.getElementById('uploadBtnTop').disabled = false;
                        showLoading(false);
                    };
                }
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'danger');
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtnTop').disabled = false;
                showLoading(false);
            }
        }
        
        // Add log entry to progress log
        function addProgressLog(message, type = 'info') {
            const log = document.getElementById('progressLog');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const colors = {
                'info': '#0d6efd',
                'success': '#198754',
                'danger': '#dc3545',
                'detail': '#6c757d'
            };
            const color = colors[type] || '#000';
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –ª–æ–≥ (detail), –∑–∞–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –ª–æ–≥
            if (type === 'detail') {
                const lastEntry = log.lastElementChild;
                if (lastEntry && lastEntry.classList.contains('detail-log')) {
                    lastEntry.style.color = color;
                    lastEntry.textContent = `[${timestamp}] ${message}`;
                    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    log.scrollTop = log.scrollHeight;
                    return;
                }
            }
            
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '5px';
            entry.textContent = `[${timestamp}] ${message}`;
            
            // –ü–æ–º–µ—á–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ª–æ–≥–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –∫–ª–∞—Å—Å–æ–º
            if (type === 'detail') {
                entry.classList.add('detail-log');
            }
            
            log.appendChild(entry);
            
            // Auto-scroll to bottom
            log.parentElement.scrollTop = log.parentElement.scrollHeight;
        }
        
        // Update progress bar
        function updateProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressBar').textContent = `${percent}%`;
            document.getElementById('progressText').textContent = message;
        }
        
        // Show results
        function showResults(data) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            data.results.forEach(result => {
                const item = document.createElement('div');
                item.className = `result-item ${result.status === 'completed' ? 'success' : 'error'}`;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${result.status === 'completed' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            <strong>–¢–æ–≤–∞—Ä ${result.product_id}</strong>
                        </div>
                        <div>
                            <span class="badge ${result.status === 'completed' ? 'bg-success' : 'bg-danger'}">
                                ${result.message}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('resultsContainer').style.display = 'block';
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        function addProductToSelection(spuOrSku) {
            const id = String(spuOrSku);
            if (!selectedProducts.has(id)) {
                selectedProducts.add(id);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞
            const checkbox = document.querySelector(`input[data-spu="${id}"]`);
            if (checkbox) {
                checkbox.checked = true;
                const productCard = checkbox.closest('.product-card');
                if (productCard) {
                    productCard.classList.add('selected');
                }
            }
            
            updateSelectedCount();
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'success');
        }

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        async function uploadProductNow(spuOrSku) {
            const id = String(spuOrSku);
            const previousSelection = new Set(selectedProducts);
            selectedProducts.clear();
            selectedProducts.add(id);
            updateSelectedCount();
            try {
                await uploadProducts();
            } finally {
                selectedProducts.clear();
                previousSelection.forEach(v => selectedProducts.add(v));
                updateSelectedCount();
            }
        }
        
        // Update step indicator
        function updateStep(stepNumber) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < stepNumber) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            }
        }
        
        // Show loading spinner
        function showLoading(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
            const spinner = document.getElementById('loadingSpinner');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = text;
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // You can implement toast notifications here
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // =====================================================================
        // UPDATE TAB FUNCTIONS
        // =====================================================================
        
        let selectedUpdateProducts = new Set();
        let wpProducts = [];
        let wpCategories = [];
        let selectedCategories = new Set();
        
        // Update price example for update tab
        function updatePriceExampleUpdate() {
            const rate = parseFloat(document.getElementById('updateCurrencyRate').value) || 13.5;
            const markup = parseFloat(document.getElementById('updateMarkupRubles').value) || 5000;
            const example = Math.round(100 * rate + markup);
            
            document.getElementById('updateRateDisplay').textContent = rate;
            document.getElementById('updateMarkupDisplay').textContent = markup;
            document.getElementById('updatePriceExample').textContent = example;
        }
        
        // Load WordPress categories
        async function loadWPCategories() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
                const response = await fetch('/api/wordpress/categories');
                const data = await response.json();
                
                console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                
                if (data.success) {
                    wpCategories = data.categories;
                    renderCategoriesTree(wpCategories);
                    document.getElementById('categoriesTree').style.display = 'block';
                    document.getElementById('selectAllCategoriesBtn').style.display = 'inline-block';
                    document.getElementById('deselectAllCategoriesBtn').style.display = 'inline-block';
                    document.getElementById('selectedCategoriesCount').style.display = 'inline';
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${wpCategories.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`, 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + error.message, 'danger');
            }
        }
        
        // Render categories tree
        function renderCategoriesTree(categories) {
            const container = document.getElementById('categoriesTree');
            container.innerHTML = '';
            
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.style.marginLeft = (cat.parent !== 0 ? '20px' : '0');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input category-checkbox';
                checkbox.id = `cat_${cat.id}`;
                checkbox.value = cat.id;
                checkbox.addEventListener('change', onCategoryCheckboxChange);
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `cat_${cat.id}`;
                label.textContent = `${cat.name} (${cat.path})`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        // On category checkbox change
        function onCategoryCheckboxChange(event) {
            const catId = parseInt(event.target.value);
            if (event.target.checked) {
                selectedCategories.add(catId);
            } else {
                selectedCategories.delete(catId);
            }
            updateCategoriesCount();
        }
        
        // Update categories count
        function updateCategoriesCount() {
            document.getElementById('categoriesCountNumber').textContent = selectedCategories.size;
            
            const badge = document.getElementById('categoryFilterBadge');
            if (selectedCategories.size > 0) {
                badge.textContent = `–§–∏–ª—å—Ç—Ä: ${selectedCategories.size} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`;
                badge.style.display = 'inline-block';
            } else {
                badge.textContent = '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                badge.style.display = 'none';
            }
        }
        
        // Select all categories
        function selectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                selectedCategories.add(parseInt(checkbox.value));
            });
            updateCategoriesCount();
        }
        
        // Deselect all categories
        function deselectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedCategories.clear();
            updateCategoriesCount();
        }
        
        // Load WordPress products
        async function loadWordPressProducts() {
            console.log('loadWordPressProducts() –≤—ã–∑–≤–∞–Ω–∞');
            const loadingSpinner = document.getElementById('updateLoadingSpinner');
            loadingSpinner.classList.add('active');
            document.getElementById('loadWPProductsBtn').disabled = true;
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                let url = '/api/wordpress/products';
                if (selectedCategories.size > 0) {
                    const categoryIds = Array.from(selectedCategories).join(',');
                    url += `?categories=${categoryIds}`;
                    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${categoryIds}`);
                    console.log(`URL: ${url}`);
                }
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', url);
                const response = await fetch(url);
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                const data = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ:', data);
                
                if (data.success) {
                    wpProducts = data.products;
                    document.getElementById('selectAllUpdateBtn').style.display = 'inline-block';
                    document.getElementById('deselectAllUpdateBtn').style.display = 'inline-block';
                    document.getElementById('updateSelectedInfo').style.display = 'inline';
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.total} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ WordPress`, 'success');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
                    const updateDays = document.getElementById('updateDaysFilter').value;
                    const createdDays = document.getElementById('createdDaysFilter').value;
                    if (updateDays || createdDays) {
                        setTimeout(() => applyDateFilters(), 100);
                    } else {
                        renderWPProducts(wpProducts);
                    }
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + error.message, 'danger');
            } finally {
                loadingSpinner.classList.remove('active');
                document.getElementById('loadWPProductsBtn').disabled = false;
            }
        }
        
        // Apply date filters
        function applyDateFilters() {
            const updateDays = document.getElementById('updateDaysFilter').value;
            const createdDays = document.getElementById('createdDaysFilter').value;
            
            if (!wpProducts || wpProducts.length === 0) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ WordPress', 'warning');
                return;
            }
            
            const now = new Date();
            let filteredProducts = [...wpProducts];
            let filterInfo = [];
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–≤–∞—Ä—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π)
            if (updateDays) {
                const updateThreshold = new Date(now.getTime() - (updateDays * 24 * 60 * 60 * 1000));
                filteredProducts = filteredProducts.filter(p => {
                    if (!p.date_modified) return true;
                    const modifiedDate = new Date(p.date_modified);
                    return modifiedDate < updateThreshold;
                });
                filterInfo.push(`–æ–±–Ω–æ–≤–ª–µ–Ω—ã –±–æ–ª–µ–µ ${updateDays} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (—Ç–æ–≤–∞—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π)
            if (createdDays) {
                const createdThreshold = new Date(now.getTime() - (createdDays * 24 * 60 * 60 * 1000));
                filteredProducts = filteredProducts.filter(p => {
                    if (!p.date_created) return true;
                    const createdDate = new Date(p.date_created);
                    return createdDate >= createdThreshold;
                });
                filterInfo.push(`–∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${createdDays} –¥–Ω–µ–π`);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
            const infoEl = document.getElementById('dateFilterInfo');
            if (filterInfo.length > 0) {
                infoEl.textContent = `–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã: ${filterInfo.join(', ')}`;
                infoEl.style.color = '#0d6efd';
            } else {
                infoEl.textContent = '';
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            renderWPProducts(filteredProducts);
            showNotification(`–ù–∞–π–¥–µ–Ω–æ ${filteredProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤`, 'success');
        }
        
        // Reset date filters
        function resetDateFilters() {
            document.getElementById('updateDaysFilter').value = '7';
            document.getElementById('createdDaysFilter').value = '';
            document.getElementById('dateFilterInfo').textContent = '';
            
            if (wpProducts && wpProducts.length > 0) {
                renderWPProducts(wpProducts);
                showNotification('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
            }
        }
        
        // Render WordPress products
        function renderWPProducts(products) {
            const container = document.getElementById('wpProductsContainer');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                return;
            }
            
            products.forEach(product => {
                console.log('Product image URL:', product.image); // –û—Ç–ª–∞–¥–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                
                const priceText = product.min_price === product.max_price 
                    ? `${product.min_price}‚ÇΩ` 
                    : `${product.min_price}‚ÇΩ - ${product.max_price}‚ÇΩ`;
                
                const stockBadge = product.total_stock > 0 
 
                    ? `<span class="badge bg-success">${product.total_stock} —à—Ç.</span>`
                    : `<span class="badge bg-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>`;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const imageUrl = product.image || 'https://via.placeholder.com/120?text=No+Image';
                    
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
                const formatDate = (dateString) => {
                    if (!dateString) return '–ù/–î';
                    const date = new Date(dateString);
                    return date.toLocaleString('ru-RU', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                };
                
                const createdDate = formatDate(product.date_created);
                const modifiedDate = formatDate(product.date_modified);
                
                const card = document.createElement('div');
                card.className = 'col-12';
                card.innerHTML = `
                    <div class="product-card" data-update-product-id="${product.id}" 
                         data-created="${product.date_created}" 
                         data-modified="${product.date_modified}">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="product-checkbox update-checkbox" data-update-product-id="${product.id}">
                            <img src="${imageUrl}" 
                                 class="product-image" 
                                 alt="${product.name}"
                                 onerror="console.error('Image load error:', this.src); this.src='https://via.placeholder.com/120?text=No+Image';">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">${product.name}</h6>
                                <div class="mb-2">
                                    <span class="badge bg-secondary">SKU: ${product.sku}</span>
                                    <span class="badge bg-info">${product.variations_count} –≤–∞—Ä–∏–∞—Ü–∏–π</span>
                                    ${stockBadge}
                                </div>
                                <div class="mb-1">
                                    <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> ${priceText}
                                </div>
                                <div class="text-muted small">
                                    <i class="fas fa-calendar-plus"></i> –ó–∞–≥—Ä—É–∂–µ–Ω: ${createdDate} <br>
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–ª–µ–Ω: ${modifiedDate}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click handler
                const checkbox = card.querySelector('.update-checkbox');
                const productCard = card.querySelector('.product-card');
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedUpdateProducts.add(product.id);
                        productCard.classList.add('selected');
                    } else {
                        selectedUpdateProducts.delete(product.id);
                        productCard.classList.remove('selected');
                    }
                    updateSelectedUpdateCount();
                });
                
                // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ - —Ç–µ–ø–µ—Ä—å —Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
                // productCard.addEventListener('click', function(e) {
                //     if (e.target.type !== 'checkbox') {
                //         e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
                //         checkbox.checked = !checkbox.checked;
                //         checkbox.dispatchEvent(new Event('change'));
                //     }
                // });
                
                container.appendChild(card);
            });
        }
        
        // Update selected count for update tab
        function updateSelectedUpdateCount() {
            const count = selectedUpdateProducts.size;
            document.getElementById('updateSelectedCount').textContent = count;
            document.getElementById('updatePricesBtn').disabled = count === 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            const updateControlPanel = document.getElementById('updateControlPanel');
            if (count > 0) {
                updateControlPanel.style.display = 'block';
            } else {
                updateControlPanel.style.display = 'none';
            }
        }
        
        // Select all update products
        function selectAllUpdateProducts() {
            document.querySelectorAll('.update-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
        
        // Deselect all update products
        function deselectAllUpdateProducts() {
            document.querySelectorAll('.update-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
        
        // Update prices and stock
        async function updatePricesAndStock() {
            if (selectedUpdateProducts.size === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä', 'warning');
                return;
            }
            
            const settings = {
                currency_rate: parseFloat(document.getElementById('updateCurrencyRate').value) || 13.5,
                markup_rubles: parseFloat(document.getElementById('updateMarkupRubles').value) || 5000
            };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoading(true, `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${selectedUpdateProducts.size} —Ç–æ–≤–∞—Ä–æ–≤...\n\n–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤`);
            
            // Show progress section
            document.getElementById('updateProgressSection').style.display = 'block';
            document.getElementById('updateProgressLog').innerHTML = '';
            document.getElementById('updateProgressBar').style.width = '0%';
            document.getElementById('updateProgressBar').textContent = '0%';
            document.getElementById('updateProgressText').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
            document.getElementById('updatePricesBtn').disabled = true;
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –±–ª–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            setTimeout(() => {
                const progressSection = document.getElementById('updateProgressSection');
                if (progressSection) {
                    progressSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
            
            try {
                // Step 1: Start update and get session_id
                const response = await fetch('/api/update-prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_ids: Array.from(selectedUpdateProducts),
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                    document.getElementById('updateProgressSection').style.display = 'none';
                    document.getElementById('updatePricesBtn').disabled = false;
                    showLoading(false);
                    return;
                }
                
                const sessionId = data.session_id;
                const totalProducts = data.total;
                let currentProduct = 0;
                let results = [];
                
                // Step 2: Connect to SSE for real-time progress
                const eventSource = new EventSource(`/api/progress/${sessionId}`);
                
                eventSource.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    
                    switch(message.type) {
                        case 'start':
                            addUpdateProgressLog(`üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${message.total} —Ç–æ–≤–∞—Ä–æ–≤...`, 'info');
                            // –°–∫—Ä—ã–≤–∞–µ–º overlay –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                            showLoading(false);
                            break;
                            
                        case 'product_start':
                            currentProduct = message.current;
                            addUpdateProgressLog(`üì¶ [${message.current}/${message.total}] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞ ID ${message.product_id}...`, 'info');
                            updateUpdateProgress(currentProduct, totalProducts, message.message);
                            break;
                            
                        case 'status_update':
                            addUpdateProgressLog(`   ‚ûú ${message.message}`, 'detail');
                            break;
                            
                        case 'product_done':
                            const icon = message.status === 'completed' ? '‚úÖ' : message.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
                            const color = message.status === 'completed' ? 'success' : message.status === 'warning' ? 'warning' : 'danger';
                            addUpdateProgressLog(`${icon} [${message.current}/${message.total}] ${message.message}`, color);
                            updateUpdateProgress(message.current, totalProducts, message.message);
                            break;
                            
                        case 'complete':
                            results = message.results;
                            addUpdateProgressLog(`‚ú® –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –£—Å–ø–µ—à–Ω–æ: ${message.updated}, –û—à–∏–±–æ–∫: ${message.errors}`, 'success');
                            showUpdateResults({results: results, total: message.total, updated: message.updated, errors: message.errors});
                            showNotification(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${message.updated} –∏–∑ ${message.total}`, 'success');
                            break;
                            
                        case 'error':
                            addUpdateProgressLog(`‚ùå –û—à–∏–±–∫–∞: ${message.message}`, 'danger');
                            showNotification('–û—à–∏–±–∫–∞: ' + message.message, 'danger');
                            break;
                            
                        case 'done':
                            eventSource.close();
                            document.getElementById('updatePricesBtn').disabled = false;
                            break;
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    addUpdateProgressLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
                    document.getElementById('updatePricesBtn').disabled = false;
                    showLoading(false);
                };
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'danger');
                document.getElementById('updateProgressSection').style.display = 'none';
                document.getElementById('updatePricesBtn').disabled = false;
                showLoading(false);
            }
        }
        
        // Add log entry to update progress log
        function addUpdateProgressLog(message, type = 'info') {
            const log = document.getElementById('updateProgressLog');
            if (!log) return;
            
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const colors = {
                'info': '#0d6efd',
                'success': '#198754',
                'danger': '#dc3545',
                'warning': '#ffc107',
                'detail': '#6c757d'
            };
            const color = colors[type] || '#000';
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –ª–æ–≥ (detail), –∑–∞–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –ª–æ–≥
            if (type === 'detail') {
                const lastEntry = log.lastElementChild;
                if (lastEntry && lastEntry.classList.contains('detail-log')) {
                    lastEntry.style.color = color;
                    lastEntry.textContent = `[${timestamp}] ${message}`;
                    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    log.scrollTop = log.scrollHeight;
                    return;
                }
            }
            
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '5px';
            entry.textContent = `[${timestamp}] ${message}`;
            
            // –ü–æ–º–µ—á–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ª–æ–≥–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –∫–ª–∞—Å—Å–æ–º
            if (type === 'detail') {
                entry.classList.add('detail-log');
            }
            
            log.appendChild(entry);
            
            // Auto-scroll to bottom
            log.parentElement.scrollTop = log.parentElement.scrollHeight;
        }
        
        // Update progress bar for update tab
        function updateUpdateProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('updateProgressBar').style.width = `${percent}%`;
            document.getElementById('updateProgressBar').textContent = `${percent}%`;
            document.getElementById('updateProgressText').textContent = message;
        }
        
        // Show update results
        function showUpdateResults(data) {
            const container = document.getElementById('updateResultsContent');
            container.innerHTML = '';
            
            data.results.forEach(result => {
                const statusClass = result.status === 'completed' ? 'success' : 
                                   result.status === 'warning' ? 'warning' : 'error';
                const icon = result.status === 'completed' ? 'fa-check-circle' : 
                            result.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
                
                const item = document.createElement('div');
                item.className = `result-item ${statusClass === 'warning' ? 'error' : statusClass}`;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${icon}"></i>
                            <strong>${result.product_name || '–¢–æ–≤–∞—Ä ' + result.product_id}</strong>
                        </div>
                        <div>
                            <span class="badge bg-${statusClass === 'warning' ? 'warning' : statusClass === 'success' ? 'success' : 'danger'}">
                                ${result.message}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('updateResultsContainer').style.display = 'block';
        }
        
        // Initialize update tab event listeners
        document.getElementById('loadCategoriesBtn').addEventListener('click', loadWPCategories);
        document.getElementById('selectAllCategoriesBtn').addEventListener('click', selectAllCategories);
        document.getElementById('deselectAllCategoriesBtn').addEventListener('click', deselectAllCategories);
        document.getElementById('loadWPProductsBtn').addEventListener('click', loadWordPressProducts);
        document.getElementById('selectAllUpdateBtn').addEventListener('click', selectAllUpdateProducts);
        document.getElementById('selectAllUpdateBtnTop').addEventListener('click', selectAllUpdateProducts);
        document.getElementById('deselectAllUpdateBtn').addEventListener('click', deselectAllUpdateProducts);
        document.getElementById('deselectAllUpdateBtnTop').addEventListener('click', deselectAllUpdateProducts);
        document.getElementById('updatePricesBtn').addEventListener('click', updatePricesAndStock);
        document.getElementById('updateCurrencyRate').addEventListener('input', updatePriceExampleUpdate);
        document.getElementById('updateMarkupRubles').addEventListener('input', updatePriceExampleUpdate);
        document.getElementById('applyDateFilters').addEventListener('click', applyDateFilters);
        document.getElementById('resetDateFilters').addEventListener('click', resetDateFilters);
        
        // Initialize update price example
        updatePriceExampleUpdate();
        
        // ==================== SCROLL BUTTONS ====================
        
        // Scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Scroll to bottom
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Show/hide scroll to top button based on scroll position
        window.addEventListener('scroll', function() {
            const scrollTopBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });
        
        // ========================================================================
        // –§–£–ù–ö–¶–ò–ò –ë–´–°–¢–†–û–ì–û –ü–û–ò–°–ö–ê
        // ========================================================================
        
        async function performQuickSearch() {
            const query = document.getElementById('quickSearchInput').value.trim();
            
            if (!query) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ SPU ID –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª', 'warning');
                return;
            }
            
            showLoading(true, `–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞: "${query}"...`);
            
            try {
                const response = await fetch(`/api/search/manual?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    const resultDiv = document.getElementById('quickSearchResults');
                    const listDiv = document.getElementById('quickSearchList');
                    const countSpan = document.getElementById('quickSearchCount');
                    
                    listDiv.innerHTML = '';
                    countSpan.textContent = data.total;
                    
                    data.products.forEach(product => {
                        const productCard = createProductCard(product);
                        listDiv.innerHTML += productCard;
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
                    document.querySelectorAll('.add-to-selection-btn').forEach(btn => {
                        btn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            event.preventDefault();
                            const spu = this.getAttribute('data-spu');
                            addProductToSelection(spu);
                        });
                    });
                    
                    document.querySelectorAll('.upload-now-btn').forEach(btn => {
                        btn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            event.preventDefault();
                            const spu = this.getAttribute('data-spu');
                            uploadProductNow(spu);
                        });
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
                    document.querySelectorAll('.quick-search-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function(event) {
                            event.stopPropagation();
                            event.preventDefault();
                            const spu = this.getAttribute('data-spu');
                            const productCard = this.closest('.product-card');
                            
                            if (this.checked) {
                                selectedProducts.add(spu);
                                productCard.classList.add('selected');
                            } else {
                                selectedProducts.delete(spu);
                                productCard.classList.remove('selected');
                            }
                            updateSelectedCount();
                        });
                        
                        checkbox.addEventListener('click', function(event) {
                            event.stopPropagation();
                        });
                    });
                    
                    resultDiv.style.display = 'block';
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                    resultDiv.scrollIntoView({ behavior: 'smooth' });
                    
                    showNotification(`–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${data.total}`, 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function closeQuickSearch() {
            document.getElementById('quickSearchResults').style.display = 'none';
            document.getElementById('quickSearchInput').value = '';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö)
        function createProductCard(product) {
            const imageUrl = Array.isArray(product.images) && product.images.length > 0 
                ? product.images[0] 
                : 'https://via.placeholder.com/150';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä Dewu
            const dewuUrl = `https://www.dewu.com/product-detail.html?sourceName=pc&spuId=${product.spuId || product.sku}&propertyValueId=0&skuId=${product.sku || product.spuId}`;
            
            return `
                <div class="col-md-4 mb-3">
                    <a href="${dewuUrl}" target="_blank" class="product-link">
                        <div class="product-card" data-spu="${product.spuId || product.sku}">
                            <div class="product-checkbox">
                                <input type="checkbox" class="form-check-input quick-search-checkbox" id="product-${product.spuId || product.sku}"
                                       data-spu="${product.spuId || product.sku}"
                                       ${selectedProducts.has(String(product.spuId || product.sku)) ? 'checked' : ''}>
                            </div>
                            <img src="${imageUrl}" alt="${product.title || '–¢–æ–≤–∞—Ä'}">
                            <div class="product-info">
                                <div class="product-title">${product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                <div class="product-price">${product.price ? product.price.toFixed(2) + ' ¬•' : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                                <div class="product-sku">SKU: ${product.sku || product.spuId}</div>
                                ${product.brand ? `<div class="product-brand">${product.brand}</div>` : ''}
                                ${product.articleNumber ? `<div class="product-article">–ê—Ä—Ç–∏–∫—É–ª: ${product.articleNumber}</div>` : ''}
                                <div class="mt-2 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-sm btn-outline-primary add-to-selection-btn" data-spu="${product.spuId || product.sku}">
                                        <i class="fas fa-plus-square"></i> –î–æ–±–∞–≤–∏—Ç—å –∫ –∑–∞–≥—Ä—É–∑–∫–µ
                                    </button>
                                    <button class="btn btn-sm btn-success upload-now-btn" data-spu="${product.spuId || product.sku}">
                                        <i class="fas fa-cloud-upload-alt"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            `;
        }
        
        // ========================================================================
        // –ü–û–ò–°–ö –ë–†–ï–ù–î–û–í
        // ========================================================================
        
        function filterBrands() {
            const input = document.getElementById('brandSearchInput');
            const filter = input.value.toLowerCase();
            const select = document.getElementById('brandSelect');
            const options = select.getElementsByTagName('option');
            
            let visibleCount = 0;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const txtValue = option.textContent || option.innerText;
                
                if (option.value === '') {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º placeholder –æ–ø—Ü–∏—é
                    option.style.display = '';
                    continue;
                }
                
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('brandCount').textContent = visibleCount;
        }
        
        function clearBrandSearch() {
            document.getElementById('brandSearchInput').value = '';
            filterBrands();
        }
        
        function updateBrandCount() {
            const select = document.getElementById('brandSelect');
            const options = select.getElementsByTagName('option');
            let count = 0;
            
            for (let i = 0; i < options.length; i++) {
                if (options[i].value !== '') {
                    count++;
                }
            }
            
            document.getElementById('brandCount').textContent = count;
        }
        
    </script>
</body>
</html>

